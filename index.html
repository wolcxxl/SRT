<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Reader IOS</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f2f2f7">
    <link rel="manifest" id="manifest-placeholder">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/007AFF/open-book.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { 
            --accent: #007AFF; --red: #ff3b30; --bg: #f2f2f7; --panel: #fff; --highlight: rgba(255, 235, 59, 0.4); 
            /* Безопасная зона + запас для iPhone 15 */
            --safe-top: calc(env(safe-area-inset-top, 20px) + 15px);
            --safe-bot: env(safe-area-inset-bottom, 20px);
        }
        body { margin:0; font-family: -apple-system, sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; overscroll-behavior: none; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* LIBRARY */
        #lib-view { padding: 80px 20px 80px; height: 100%; overflow-y: auto; }
        
        .lib-settings { background: var(--panel); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
        .lib-settings-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .lib-label { font-size: 13px; color: #666; font-weight: 500; }
        .lib-select { padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9; flex: 1; font-weight: bold; }
        .upload-container { position: relative; width: 100%; height: 55px; margin-bottom: 20px; }
        .upload-visual { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--accent); color: white; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 16px; box-shadow: 0 4px 10px rgba(0,122,255,0.3); z-index: 1; }
        #file-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; z-index: 999; cursor: pointer; }
        .book-card { background: var(--panel); padding: 15px; margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; transition: background 0.1s; cursor: pointer; user-select: none; }
        .book-card:active { background: #e5e5e5; transform: scale(0.98); }
        .book-info { flex: 1; display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .book-type { font-size: 10px; padding: 3px 6px; border-radius: 4px; background: #eee; color: #555; font-weight: bold; flex-shrink: 0;}
        .book-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 16px; }
        .book-actions { display: flex; gap: 15px; margin-left: 10px; }
        .action-btn { color: #888; padding: 5px; font-size: 16px; transition: color 0.2s; }
        .action-btn.edit:hover { color: var(--accent); } .action-btn.del:hover { color: var(--red); }

        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 4000; justify-content: center; align-items: center; flex-direction: column; text-align: center; padding: 20px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loader-text { color: #555; font-weight: 500; }

        /* READER LAYOUT - IPHONE 15 FIX */
        #read-view { display: none; flex-direction: column; height: 100%; background: #fff; }
        
        .top-bar { 
            /* Спускаем шапку ниже Dynamic Island */
            padding-top: var(--safe-top); 
            height: calc(50px + var(--safe-top)); 
            display: flex; align-items: center; justify-content: space-between; 
            padding-left: 15px; padding-right: 15px; 
            background: #f8f8f8; border-bottom: 1px solid #ddd; 
        }
        
        .split { flex: 1; display: flex; overflow: hidden; position: relative; touch-action: none; }
        .split.vertical { flex-direction: column; }
        .page { flex: 1; padding: 20px; overflow-y: auto; font-size: 17px; line-height: 1.6; -webkit-overflow-scrolling: touch; overscroll-behavior: none; position: relative; }
        .page img { max-width: 100%; border-radius: 8px; margin: 10px auto; display: block; }
        .sync-active { background-color: var(--highlight); border-radius: 4px; transition: background 0.2s; cursor: pointer; }
        .page p { margin-bottom: 10px; cursor: pointer; }

        /* UI FIXES: RESIZER & HANDLE */
        .resizer { background: #e0e0e0; z-index: 100; display: flex; justify-content: center; align-items: center; }
        .split:not(.vertical) .resizer { width: 12px; margin: 0 -6px; cursor: col-resize; }
        .split.vertical .resizer { height: 12px; margin: -6px 0; cursor: row-resize; }
        
        .handle { 
            width: 44px; height: 44px; border-radius: 50%; 
            background: var(--accent); color: white; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 16px; border: 3px solid #fff; 
            pointer-events: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex-shrink: 0; z-index: 101;
        }
        .handle.is-close { background: var(--red); }
        .split.is-hidden .handle { width: 56px; height: 56px; font-size: 20px; border-width: 4px; }

        .bot-bar { 
            padding-bottom: var(--safe-bot);
            height: calc(50px + var(--safe-bot)); 
            display: flex; align-items: center; justify-content: space-between; 
            padding-left: 20px; padding-right: 20px; 
            background: #f8f8f8; border-top: 1px solid #ddd; 
        }
        .nav-btn { font-size: 24px; color: var(--accent); background: none; border: none; padding: 10px; }

        /* MENU POSITION FIX */
        #settings { 
            position: absolute; 
            top: calc(50px + var(--safe-top)); /* Сдвигаем меню под новую высокую шапку */
            left: 0; width: 100%; 
            background: white; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            transform: translateY(-200%); transition: 0.3s; 
            z-index: 2000; border-bottom: 1px solid #eee; 
        }
        #settings.open { transform: translateY(0); }
        
        /* DICT */
        #dict-popup { display: none; position: absolute; z-index: 3000; background: #333; color: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-width: 250px; font-size: 14px; text-align: center; }
        #dict-popup::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .dict-word { font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 5px; display: block; }
        .dict-trans { display: block; margin-bottom: 5px; }
        .dict-actions { display: flex; justify-content: center; gap: 15px; margin-top: 5px; }
        .dict-btn { background: none; border: none; color: #4db6ac; cursor: pointer; font-size: 16px; }

        .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        select, button { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; background: white; height: 40px; }
        button.active { background: var(--accent); color: white; border-color: var(--accent); }
        input[type=range] { width: 100%; height: 5px; border-radius: 5px; background: #d3d3d3; outline: none; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div id="loader-text">Загрузка...</div></div>

<div id="dict-popup">
    <span class="dict-word" id="dict-orig">Word</span>
    <span class="dict-trans" id="dict-res">...</span>
    <div class="dict-actions">
        <button class="dict-btn" onclick="speakWord()"><i class="fas fa-volume-up"></i></button>
        <button class="dict-btn" onclick="closePopup()" style="color:#ff5252"><i class="fas fa-times"></i></button>
    </div>
</div>

<div id="lib-view">
    <h1 style="margin-bottom: 20px;">Мои Книги</h1>
    <div class="lib-settings">
        <div class="lib-settings-row">
            <span class="lib-label">Оригинал:</span>
            <select id="lib-from" class="lib-select" onchange="saveLibSettings()"><option value="auto">Авто</option><option value="en">EN</option><option value="de">DE</option><option value="fr">FR</option><option value="zh">CN</option></select>
        </div>
        <div class="lib-settings-row">
            <span class="lib-label">Перевод на:</span>
            <select id="lib-to" class="lib-select" onchange="saveLibSettings()"><option value="ru" selected>Русский</option><option value="en">EN</option><option value="uk">UK</option><option value="kk">KZ</option></select>
        </div>
    </div>
    <div class="upload-container">
        <div class="upload-visual"><i class="fas fa-plus"></i>&nbsp; Добавить книгу</div>
        <input type="file" id="file-input">
    </div>
    <div id="book-list"></div>
</div>

<div id="read-view">
    <div class="top-bar">
        <button onclick="toggleMenu()" style="flex:0 auto; border:none; color:var(--accent); font-weight:bold; background:none"><i class="fas fa-cog"></i> Меню</button>
        <button onclick="toggleTrans()" id="btn-trans" style="flex:0 auto; border:1px solid var(--accent); color:var(--accent); padding:5px 15px; border-radius:15px; font-size:12px">Перевод: OFF</button>
    </div>

    <div id="settings">
        <div class="row">
            <select id="lang-from"><option value="auto">Авто</option><option value="en">EN</option><option value="de">DE</option><option value="fr">FR</option><option value="zh">CN</option></select>
            <i class="fas fa-arrow-right" style="color:#ccc"></i>
            <select id="lang-to"><option value="ru">RU</option><option value="en">EN</option><option value="uk">UK</option><option value="kk">KZ</option></select>
        </div>
        <div class="row"><button onclick="setLayout('h')" id="btn-h">|| Верт</button><button onclick="setLayout('v')" id="btn-v">= Гориз</button></div>
        <div class="row">
            <select id="font-family" onchange="updateStyle()"><option value="-apple-system, sans-serif">System</option><option value="'Georgia', serif">Serif</option><option value="'Courier New', monospace">Mono</option></select>
            <button onclick="toggleBold()" id="btn-bold" style="flex:0 0 50px; font-weight:bold">B</button>
        </div>
        <div style="margin-bottom: 15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span class="label">Размер</span><span class="label" style="text-align:right" id="size-val">17px</span></div>
            <input type="range" id="font-size" min="12" max="32" value="17" oninput="updateStyle()">
        </div>
        <div class="row"><button onclick="closeBook()" style="background:var(--red); color:white; border:none">Закрыть книгу</button></div>
    </div>

    <div class="split" id="split">
        <div class="page" id="p1"></div>
        <div class="resizer" id="resizer">
            <div class="handle is-close" id="handle"><i class="fas fa-times"></i></div>
        </div>
        <div class="page" id="p2" style="background:#f9f9f9; color:#555"></div>
    </div>

    <div class="bot-bar">
        <button class="nav-btn" onclick="nav(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="lbl" style="font-weight:600; color:#555">0/0</span>
        <button class="nav-btn" onclick="nav(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<script>
    const m = { "name":"Reader", "display":"standalone", "background_color":"#f2f2f7", "theme_color":"#007AFF", "icons":[{ "src":"https://img.icons8.com/ios-filled/192/007AFF/open-book.png", "sizes":"192x192", "type":"image/png" }] };
    document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(m)], {type: 'application/json'})));

    let db, pages=[], cur=0, trans=false, hidden=false, cache={};
    let isBold = false; let isSyncing = false;
    let rawParagraphs = [];

    // --- TTS WARMUP ---
    let ttsWarmed = false;
    function warmUpTTS() {
        if(ttsWarmed) return;
        window.speechSynthesis.getVoices(); 
        const u = new SpeechSynthesisUtterance(''); u.volume = 0; window.speechSynthesis.speak(u);
        ttsWarmed = true;
    }
    document.body.addEventListener('touchstart', warmUpTTS, {once:true});
    document.body.addEventListener('click', warmUpTTS, {once:true});

    // --- DB ---
    const req = indexedDB.open("ReaderV27", 1);
    req.onupgradeneeded = e => { db=e.target.result; db.createObjectStore("books",{keyPath:"id",autoIncrement:true}); };
    req.onsuccess = e => { db=e.target.result; loadLib(); restoreLibSettings(); };

    function saveLibSettings() {
        localStorage.setItem('lib-from', document.getElementById('lib-from').value);
        localStorage.setItem('lib-to', document.getElementById('lib-to').value);
    }
    function restoreLibSettings() {
        if(localStorage.getItem('lib-from')) document.getElementById('lib-from').value = localStorage.getItem('lib-from');
        if(localStorage.getItem('lib-to')) document.getElementById('lib-to').value = localStorage.getItem('lib-to');
    }

    document.getElementById('file-input').addEventListener('change', async function(e) {
        const f = e.target.files[0]; if(!f) return;
        showLoader("Анализ...");
        const type = f.name.split('.').pop().toLowerCase();
        let content = null;
        try {
            if(type === 'epub' || type === 'pdf') content = await f.arrayBuffer();
            else content = await new Promise((r) => { const rd = new FileReader(); rd.onload = ev => r(ev.target.result); rd.readAsText(f); });
            const tx = db.transaction("books", "readwrite");
            tx.objectStore("books").add({ name: f.name, type: type, content: content });
            tx.oncomplete = () => { hideLoader(); loadLib(); this.value = ''; };
        } catch(err) { hideLoader(); alert("Ошибка: " + err.message); }
    });

    function showLoader(t) { document.getElementById('loader-text').innerText = t; document.getElementById('loader').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }

    function loadLib() {
        const l = document.getElementById('book-list'); l.innerHTML = '';
        db.transaction("books").objectStore("books").openCursor().onsuccess = e => {
            const c = e.target.result;
            if(c) {
                const id=c.value.id; const name=c.value.name; const type=(c.value.type||'TXT').toUpperCase();
                const d = document.createElement('div'); d.className = 'book-card';
                d.innerHTML = `
                    <div class="book-info"><span class="book-type">${type}</span><div class="book-name">${name}</div></div>
                    <div class="book-actions">
                        <i class="fas fa-pen action-btn edit" onclick="renameBook(event, ${id}, '${name.replace(/'/g, "\\'")}')"></i>
                        <i class="fas fa-trash action-btn del" onclick="deleteBook(event, ${id})"></i>
                    </div>
                `;
                d.onclick = (e) => { if(!e.target.closest('.action-btn')) loadAndOpen(id); };
                l.appendChild(d); c.continue();
            }
        };
    }

    function renameBook(e, id, oldName) {
        e.stopPropagation();
        const newName = prompt("Название:", oldName);
        if(newName && newName.trim()) {
            const tx = db.transaction("books", "readwrite");
            const store = tx.objectStore("books");
            store.get(id).onsuccess = (ev) => { const data = ev.target.result; data.name = newName; store.put(data); loadLib(); };
        }
    }
    function deleteBook(e, id) {
        e.stopPropagation();
        if(confirm("Удалить?")) {
            const tx = db.transaction("books", "readwrite");
            tx.objectStore("books").delete(id);
            tx.oncomplete = loadLib;
        }
    }

    async function loadAndOpen(id) {
        showLoader("Открываем...");
        const tx = db.transaction("books", "readonly");
        const req = tx.objectStore("books").get(id);
        req.onsuccess = async e => {
            const book = e.target.result;
            if(book) {
                try {
                    await parseAndRender(book);
                    document.getElementById('lib-view').style.display='none';
                    document.getElementById('read-view').style.display='flex';
                    hideLoader();
                } catch(err) { hideLoader(); alert("Ошибка: " + err.message); }
            }
        };
    }

    async function parseAndRender(book) {
        cache = {}; document.getElementById('p2').innerHTML = ""; 
        pages = []; rawParagraphs = [];
        
        const type = book.type;
        document.getElementById('lang-from').value = document.getElementById('lib-from').value;
        document.getElementById('lang-to').value = document.getElementById('lib-to').value;

        if (type === 'pdf') await parsePDF(book.content);
        else if (type === 'epub') await parseEPUB(book.content);
        else if (book.content.includes('<FictionBook') || book.content.includes('<?xml')) parseFB2(book.content);
        else parseTXT(book.content);

        repaginate();
        if(pages.length === 0) pages.push({left: "<p>Пусто</p>", right: ""});
        cur=0; render();
        document.getElementById('settings').classList.remove('open');
    }

    // --- CHUNKING ---
    function repaginate() {
        pages = [];
        let buf = "";
        for (let i = 0; i < rawParagraphs.length; i++) {
            buf += rawParagraphs[i];
            if (buf.length > 1000) {
                pages.push({ left: buf, right: null });
                buf = "";
            }
        }
        if (buf.length > 0) pages.push({ left: buf, right: null });
    }

    // --- GOOGLE API ---
    async function googleTranslate(html, from, to) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const textNodes = [];
        const walk = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
        let n;
        while(n = walk.nextNode()) { if(n.textContent.trim().length > 0) textNodes.push(n); }
        if(textNodes.length === 0) return html;

        const separator = ' ||| ';
        const fullText = textNodes.map(node => node.textContent).join(separator);
        
        const targetUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURIComponent(fullText)}`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

        try {
            const res = await fetch(proxyUrl);
            if(!res.ok) throw new Error('Status ' + res.status);
            const data = await res.json();
            const translatedFull = data[0].map(x => x[0]).join('');
            const translatedParts = translatedFull.split(separator.trim());
            for(let i=0; i < textNodes.length && i < translatedParts.length; i++) textNodes[i].textContent = translatedParts[i];
            return tempDiv.innerHTML;
        } catch(e) {
            return `<div style="color:#d32f2f">Ошибка сети.</div>` + html;
        }
    }

    // --- POPUP ---
    const popup = document.getElementById('dict-popup');
    document.getElementById('p1').addEventListener('click', async (e) => {
        closePopup();
        let range, word = "";
        if (document.caretRangeFromPoint) range = document.caretRangeFromPoint(e.clientX, e.clientY);
        else if (document.caretPositionFromPoint) {
            const pos = document.caretPositionFromPoint(e.clientX, e.clientY);
            range = document.createRange(); range.setStart(pos.offsetNode, pos.offset); range.collapse(true);
        }
        if (range && range.startContainer.nodeType === 3) {
            range.expand('word');
            word = range.toString().trim();
            if (word.length > 0 && /[\wа-яА-ЯёЁ]/i.test(word)) showPopup(word, e.pageX, e.pageY);
        }
    });

    async function showPopup(word, x, y) {
        document.getElementById('dict-orig').innerText = word;
        document.getElementById('dict-res').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        popup.style.display = 'block';
        
        let left = x - (popup.offsetWidth / 2);
        let top = y - popup.offsetHeight - 15;
        if (left < 10) left = 10;
        if (left + popup.offsetWidth > window.innerWidth) left = window.innerWidth - popup.offsetWidth - 10;
        if (top < 10) top = y + 20;
        popup.style.left = left + 'px'; popup.style.top = top + 'px';

        const from = document.getElementById('lang-from').value;
        const to = document.getElementById('lang-to').value;
        const targetUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURIComponent(word)}`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
        
        try {
            const res = await fetch(proxyUrl);
            const data = await res.json();
            document.getElementById('dict-res').innerText = data[0][0][0];
        } catch (e) { document.getElementById('dict-res').innerText = "Ошибка"; }
    }

    function closePopup() { popup.style.display = 'none'; }

    function speakWord() {
        const word = document.getElementById('dict-orig').innerText;
        const from = document.getElementById('lang-from').value;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = from === 'auto' ? 'en-US' : from; 
        window.speechSynthesis.speak(utterance);
    }

    // --- PARSERS ---
    async function parsePDF(buffer) {
        showLoader("PDF...");
        const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            showLoader(`PDF: ${i}/${pdf.numPages}`);
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            if(pageText.trim()) rawParagraphs.push(`<p>${pageText}</p>`);
        }
    }
    async function parseEPUB(buffer) {
        showLoader("EPUB...");
        const zip = new JSZip();
        await zip.loadAsync(buffer);
        const container = await zip.file("META-INF/container.xml").async("text");
        const parser = new DOMParser();
        const rootPath = parser.parseFromString(container, "text/xml").getElementsByTagName("rootfile")[0].getAttribute("full-path");
        const rootDir = rootPath.substring(0, rootPath.lastIndexOf('/') + 1);
        const opfContent = await zip.file(rootPath).async("text");
        const opfDoc = parser.parseFromString(opfContent, "text/xml");
        const manifest = opfDoc.getElementsByTagName("manifest")[0];
        const spine = opfDoc.getElementsByTagName("spine")[0];
        const resources = {};
        const manifestItems = manifest.getElementsByTagName("item");
        for (let i = 0; i < manifestItems.length; i++) {
            const item = manifestItems[i];
            const href = item.getAttribute("href");
            const mediaType = item.getAttribute("media-type");
            if (mediaType.startsWith("image/")) {
                const imgFile = zip.file(rootDir + href);
                if (imgFile) {
                    const imgBlob = await imgFile.async("blob");
                    const url = URL.createObjectURL(imgBlob);
                    resources[href] = url; resources[rootDir + href] = url;
                }
            }
        }
        const spineItems = spine.getElementsByTagName("itemref");
        for (let i = 0; i < spineItems.length; i++) {
            showLoader(`EPUB: Глава ${i+1}`);
            const idref = spineItems[i].getAttribute("idref");
            let href = "";
            for(let j=0; j<manifestItems.length; j++) { if(manifestItems[j].getAttribute("id")===idref) { href=manifestItems[j].getAttribute("href"); break; } }
            if(href) {
                let chContent = await zip.file(rootDir + href).async("text");
                chContent = chContent.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, "").replace(/<style\b[^>]*>([\s\S]*?)<\/style>/gim, "");
                for (const [key, blobUrl] of Object.entries(resources)) {
                    const filename = key.split('/').pop();
                    const regex = new RegExp(`src=["'].*?${filename}["']`, 'g');
                    chContent = chContent.replace(regex, `src="${blobUrl}"`);
                }
                const chDoc = parser.parseFromString(chContent, "text/html") || parser.parseFromString(chContent, "application/xhtml+xml");
                if(chDoc.body) extractParagraphs(chDoc.body);
            }
        }
    }
    
    function extractParagraphs(element) {
        const walker = document.createTreeWalker(element, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT);
        let node;
        while(node = walker.nextNode()) {
            if(node.nodeType === 3) {
                const txt = node.textContent.trim();
                if(txt.length > 0) {
                    const pTag = node.parentElement.tagName;
                    if(['P','DIV','H1','H2','H3','LI'].includes(pTag)) rawParagraphs.push(`<p>${txt}</p>`);
                }
            } else if (node.nodeType === 1 && node.tagName === 'IMG') {
                rawParagraphs.push(node.outerHTML);
            }
        }
    }

    function parseFB2(xml) {
        xml = xml.replace(/xmlns.*?=".*?"/g, ''); 
        const parser = new DOMParser();
        const doc = parser.parseFromString(xml, "text/xml");
        const bins = {};
        const bNodes = doc.getElementsByTagName('binary');
        for(let i=0; i<bNodes.length; i++) bins[bNodes[i].getAttribute('id')] = `data:${bNodes[i].getAttribute('content-type')};base64,${bNodes[i].textContent}`;
        const body = doc.getElementsByTagName('body')[0];
        if(!body) { parseTXT(xml); return; }
        const all = body.getElementsByTagName('*');
        for(let i=0; i<all.length; i++) {
            const el = all[i];
            const tag = el.tagName.toLowerCase();
            if(el.parentNode.tagName.toLowerCase() === 'p' || el.parentNode.tagName.toLowerCase() === 'title') continue;
            if(tag === 'title') rawParagraphs.push(`<h3>${el.textContent}</h3>`);
            else if(tag === 'p') rawParagraphs.push(`<p>${el.textContent}</p>`);
            else if(tag === 'image') {
                let h = el.getAttribute('l:href') || el.getAttribute('xlink:href') || el.getAttribute('href');
                if(h && h.startsWith('#')) h = h.substring(1);
                if(bins[h]) rawParagraphs.push(`<img src="${bins[h]}">`);
            }
        }
    }

    function parseTXT(t) {
        t.split('\n').forEach(l => { if(l.trim()) rawParagraphs.push(`<p>${l}</p>`); });
    }

    // --- RENDER & SYNC (FINAL FIX) ---
    const p1 = document.getElementById('p1'); const p2 = document.getElementById('p2');
    
    // ANTI-SHAKE SCROLL FOR iOS
    let activePanel = null;
    p1.addEventListener('touchstart', () => { activePanel = p1; }, {passive: true});
    p2.addEventListener('touchstart', () => { activePanel = p2; }, {passive: true});
    p1.addEventListener('mouseenter', () => { activePanel = p1; });
    p2.addEventListener('mouseenter', () => { activePanel = p2; });

    function syncScroll(source, target) {
        if (activePanel && source !== activePanel) return;
        if(isSyncing) return; isSyncing = true;
        const p = source.scrollTop / (source.scrollHeight - source.clientHeight);
        target.scrollTop = p * (target.scrollHeight - target.clientHeight);
        setTimeout(() => isSyncing = false, 20);
    }
    p1.addEventListener('scroll', () => syncScroll(p1, p2));
    p2.addEventListener('scroll', () => syncScroll(p2, p1));

    function render() {
        const pageData = pages[cur] || { left: "", right: "" };
        p1.innerHTML = pageData.left;
        document.getElementById('lbl').innerText = `${cur+1}/${pages.length}`;
        p1.scrollTop = 0; p2.scrollTop = 0;
        
        if(trans) {
            const k = cur+'_t_'+document.getElementById('lang-to').value;
            if(cache[k]) { p2.innerHTML = cache[k]; setTimeout(() => syncScroll(p1, p2), 50); }
            else { 
                p2.innerHTML = '<div style="padding:20px; color:#888; text-align:center"><i class="fas fa-spinner fa-spin"></i> Перевод (Google)...</div>';
                const from = document.getElementById('lang-from').value;
                const to = document.getElementById('lang-to').value;
                googleTranslate(pageData.left, from, to).then(t => { cache[k] = t; p2.innerHTML = t; setTimeout(() => syncScroll(p1, p2), 50); });
            }
        } else p2.innerHTML = "";
    }

    function nav(d) { if(cur+d>=0 && cur+d<pages.length) { cur+=d; render(); } }
    function toggleMenu() { document.getElementById('settings').classList.toggle('open'); }
    function closeBook() { document.getElementById('read-view').style.display='none'; document.getElementById('lib-view').style.display='block'; closePopup(); }
    
    function toggleTrans() { 
        trans = !trans; 
        const btn = document.getElementById('btn-trans');
        btn.innerText = trans ? "Перевод: ON" : "Перевод: OFF";
        btn.style.background = trans ? 'var(--accent)' : 'none';
        btn.style.color = trans ? 'white' : 'var(--accent)';
        render(); 
    }
    
    function setLayout(m) {
        const s = document.getElementById('split');
        if(m==='v') s.classList.add('vertical'); else s.classList.remove('vertical');
        p1.style.flexBasis = '50%'; p2.style.flexBasis = '50%';
    }
    function updateStyle() {
        const size = document.getElementById('font-size').value;
        const family = document.getElementById('font-family').value;
        const weight = isBold ? 'bold' : 'normal';
        document.getElementById('size-val').innerText = size + 'px';
        [p1, p2].forEach(el => { el.style.fontSize = size + 'px'; el.style.fontFamily = family; el.style.fontWeight = weight; });
    }
    function toggleBold() {
        isBold = !isBold;
        const btn = document.getElementById('btn-bold');
        if(isBold) { btn.style.background = "var(--accent)"; btn.style.color="white"; } else { btn.style.background = "white"; btn.style.color="black"; }
        updateStyle();
    }

    let touchStartX = 0; let touchStartY = 0;
    const splitEl = document.getElementById('split');
    splitEl.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].clientX; touchStartY = e.changedTouches[0].clientY; }, {passive: true});
    splitEl.addEventListener('touchend', e => {
        if(isResizing) return;
        const diffX = touchStartX - e.changedTouches[0].clientX;
        const diffY = touchStartY - e.changedTouches[0].clientY;
        if(Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) { if(diffX > 0) nav(1); else nav(-1); }
    });

    const rs = document.getElementById('resizer'); const sc = document.getElementById('split'); let isResizing = false;
    rs.addEventListener('pointerdown', e => { if(e.target.closest('#handle')) return; isResizing=true; rs.setPointerCapture(e.pointerId); rs.addEventListener('pointermove', onMove); rs.addEventListener('pointerup', onUp); });
    function onMove(e) {
        if(!isResizing) return;
        const r = sc.getBoundingClientRect();
        const isV = sc.classList.contains('vertical');
        let pct = isV ? (e.clientY - r.top)/r.height : (e.clientX - r.left)/r.width;
        pct = Math.max(0.1, Math.min(0.9, pct))*100;
        p1.style.flexBasis = pct+'%'; p2.style.flexBasis = (100-pct)+'%';
    }
    function onUp(e) { isResizing=false; rs.releasePointerCapture(e.pointerId); }
    document.getElementById('handle').onclick = e => {
        e.stopPropagation(); hidden = !hidden;
        p2.style.display = hidden ? 'none' : 'block';
        p1.style.flexBasis = hidden ? '100%' : '50%';
        const hdl = e.currentTarget;
        const splitContainer = document.getElementById('split');
        if(hidden) { hdl.innerHTML = '<i class="fas fa-chevron-left"></i>'; hdl.classList.remove('is-close'); splitContainer.classList.add('is-hidden'); }
        else { hdl.innerHTML = '<i class="fas fa-times"></i>'; hdl.classList.add('is-close'); splitContainer.classList.remove('is-hidden'); syncScroll(p1, p2); }
    };
</script>
</body>
</html>
