<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Reader v7.0 (Encoding Fix)</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg: #f2f2f7; --panel: #fff; --text: #000; --accent: #007AFF;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bot: env(safe-area-inset-bottom, 20px);
        }
        body { margin:0; font-family:-apple-system, sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

        /* HEADER & LIBRARY */
        #lib-view { padding: calc(var(--safe-top)+20px) 20px 80px 20px; overflow-y:auto; height:100%; }
        
        .control-panel {
            background: var(--panel); padding: 15px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        
        .upload-row { display: flex; gap: 10px; margin-top: 10px; }
        
        select.enc-select {
            padding: 12px; border-radius: 10px; border: 1px solid #ddd;
            background: #f8f8f8; font-weight: bold; width: 40%; font-size: 13px;
        }

        .btn-upload {
            flex: 1; background: var(--accent); color: white; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; position: relative; overflow: hidden;
        }
        .btn-upload input { position: absolute; left:0; top:0; width:100%; height:100%; opacity:0; }

        .book-item {
            background: var(--panel); padding: 15px; margin-bottom: 10px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; cursor: pointer;
        }

        /* READER */
        #read-view { display:none; flex-direction:column; height:100%; background:var(--panel); }
        
        .top-bar {
            padding-top: var(--safe-top); height: calc(50px + var(--safe-top));
            display: flex; align-items: center; justify-content: space-between; padding-left: 15px; padding-right: 15px;
            border-bottom: 1px solid #eee;
        }

        .split-area { flex: 1; display: flex; overflow: hidden; position: relative; }
        .page { flex: 1; padding: 20px; overflow-y: auto; font-size: 18px; line-height: 1.6; text-align: justify; }
        .page p { margin-bottom: 10px; }
        .page img { max-width: 100%; border-radius: 8px; margin: 10px auto; display: block; }

        .trans-page { border-left: 1px solid #ddd; background: #fafafa; color: #555; display: none; }
        .trans-page.visible { display: block; }

        .bot-bar {
            padding-bottom: var(--safe-bot); height: calc(50px + var(--safe-bot));
            display: flex; align-items: center; justify-content: space-between; padding-left: 20px; padding-right: 20px;
            border-top: 1px solid #eee; background: var(--panel);
        }
        
        .nav-btn { font-size: 22px; color: var(--accent); padding: 10px; background: none; border: none; }

        /* UTILS */
        .debug-box {
            padding: 15px; margin: 20px; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 8px; word-break: break-all; font-family: monospace; font-size: 10px; max-height: 200px; overflow: auto;
        }
        .hidden { display: none !important; }

    </style>
</head>
<body>

<div id="lib-view">
    <h1>Библиотека</h1>
    
    <div class="control-panel">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">1. Выберите кодировку (важно для FB2!):</div>
        <div class="upload-row">
            <select id="encoding-select" class="enc-select">
                <option value="windows-1251" selected>Win-1251 (RU)</option>
                <option value="utf-8">UTF-8</option>
            </select>
            
            <div class="btn-upload">
                2. Добавить файл
                <input type="file" id="file-input">
            </div>
        </div>
        <div style="font-size: 10px; color: #999; margin-top: 8px;">
            Попробуйте Win-1251, если книга не открывалась.
        </div>
    </div>

    <div id="book-list"></div>
    <div style="text-align: center; margin-top: 30px;">
        <button onclick="clearDB()" style="color: red; background: none; border: none;">Очистить базу данных</button>
    </div>
</div>

<div id="read-view">
    <div class="top-bar">
        <button onclick="closeBook()" style="color: var(--accent); background: none; border: none; font-weight: bold;">Закрыть</button>
        <button onclick="toggleTrans()" id="btn-trans" style="font-size: 12px; padding: 5px 10px; border-radius: 15px; border: 1px solid var(--accent); background: white;">Перевод: OFF</button>
    </div>

    <div class="split-area">
        <div class="page" id="p-orig"></div>
        <div class="page trans-page" id="p-trans"></div>
    </div>

    <div class="bot-bar">
        <button class="nav-btn" onclick="nav(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="page-lbl" style="font-size: 14px; font-weight: 600;">0/0</span>
        <button class="nav-btn" onclick="nav(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<script>
    // --- SETUP ---
    let db, pages = [], cur = 0, trans = false;
    let rawContentDebug = ""; // Для отладки

    // --- DB INIT ---
    const req = indexedDB.open("ReaderV7", 1);
    req.onupgradeneeded = e => { db = e.target.result; db.createObjectStore("books", {keyPath:"id", autoIncrement:true}); };
    req.onsuccess = e => { db = e.target.result; loadLib(); };

    // --- UPLOAD HANDLER ---
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;

        // Берем выбранную кодировку
        const encoding = document.getElementById('encoding-select').value;
        
        const reader = new FileReader();
        reader.readAsText(file, encoding); // Читаем СРАЗУ с нужной кодировкой
        
        reader.onload = ev => {
            const content = ev.target.result;
            const tx = db.transaction("books", "readwrite");
            // Сохраняем имя файла с пометкой кодировки, чтобы вы знали
            tx.objectStore("books").add({ 
                name: file.name + ` (${encoding === 'windows-1251' ? 'Win' : 'UTF'})`, 
                content: content 
            });
            tx.oncomplete = loadLib;
            this.value = '';
        };
        reader.onerror = () => alert("Ошибка чтения файла");
    });

    function loadLib() {
        const list = document.getElementById('book-list'); list.innerHTML = '';
        db.transaction("books").objectStore("books").openCursor().onsuccess = e => {
            const c = e.target.result;
            if(c) {
                const d = document.createElement('div'); d.className = 'book-item';
                d.innerHTML = `<div><b>${c.value.name}</b></div><i class="fas fa-chevron-right"></i>`;
                d.onclick = () => openBook(c.value.content);
                list.appendChild(d);
                c.continue();
            }
        };
    }

    // --- OPEN & PARSE ---
    function openBook(text) {
        rawContentDebug = text.substring(0, 500); // Сохраняем начало для отладки
        document.getElementById('lib-view').style.display = 'none';
        document.getElementById('read-view').style.display = 'flex';

        pages = parseText(text);

        // Если парсер вернул пустоту — показываем диагностику
        if (pages.length === 0) {
            pages = [`
                <div style="color:red; text-align:center;">
                    <h3>Текст не найден!</h3>
                    <p>Возможно, неверная кодировка.</p>
                    <button onclick="alert(rawContentDebug)" style="padding:10px; margin:10px; border:1px solid red;">Показать "Сырой текст"</button>
                    <p>Если в "Сыром тексте" вы видите  (ромбики) — удалите книгу и загрузите снова с другой кодировкой.</p>
                </div>
            `];
        }

        cur = 0;
        render();
    }

    function parseText(txt) {
        let res = [];
        let buf = "";
        
        // 1. Извлекаем картинки (Binary)
        const binaries = {};
        const binRegex = /<binary\s+[^>]*id=["']([^"']+)["'][^>]*>([\s\S]*?)<\/binary>/gi;
        let bMatch;
        while ((bMatch = binRegex.exec(txt)) !== null) {
            binaries[bMatch[1]] = `data:image/png;base64,${bMatch[2].trim()}`;
        }

        // 2. Очищаем текст для простоты
        // Удаляем description, binaries, stylesheet чтобы они не мешали
        txt = txt.replace(/<description>[\s\S]*?<\/description>/gi, "");
        txt = txt.replace(/<binary[\s\S]*?<\/binary>/gi, "");
        
        // 3. Супер-простой поиск параграфов <p> и картинок <image>
        // Используем [\s\S]*? вместо . для переносов строк
        const regex = /<(p|title)[^>]*>([\s\S]*?)<\/\1>|<image\s+[^>]*l:href=["']#?([^"']+)["'][^>]*\/?>/gi;
        
        let match;
        let count = 0;
        
        while ((match = regex.exec(txt)) !== null) {
            const tag = match[1] ? match[1].toLowerCase() : 'image';
            
            if (tag === 'title') {
                // Заголовки
                const clean = match[2].replace(/<[^>]+>/g, ''); 
                if(clean.trim()) buf += `<h3 style="color:#007AFF; margin-top:20px">${clean}</h3>`;
            } 
            else if (tag === 'p') {
                // Текст
                buf += `<p>${match[2]}</p>`;
                count += match[2].length;
            } 
            else if (tag === 'image') {
                // Картинки
                const id = match[3];
                if(binaries[id]) buf += `<img src="${binaries[id]}">`;
            }

            // Разбивка на страницы (1500 символов)
            if (count > 1500) {
                res.push(buf);
                buf = "";
                count = 0;
            }
        }

        if (buf) res.push(buf);

        // FALLBACK: Если XML не сработал, пробуем просто разбить по строкам (для TXT)
        if (res.length === 0 && txt.length > 0) {
            const lines = txt.split('\n');
            lines.forEach(line => {
                if(line.trim()) buf += `<p>${line}</p>`;
                if(buf.length > 1500) { res.push(buf); buf = ""; }
            });
            if(buf) res.push(buf);
        }

        return res;
    }

    // --- UI ---
    async function render() {
        const content = pages[cur] || "";
        document.getElementById('p-orig').innerHTML = content;
        document.getElementById('page-lbl').innerText = `${cur+1} / ${pages.length}`;
        document.getElementById('p-orig').scrollTop = 0;
        
        const trEl = document.getElementById('p-trans');
        if(trans) {
            trEl.innerHTML = "<i>Загрузка перевода...</i>";
            // Имитация перевода
            setTimeout(() => {
                trEl.innerHTML = content.replace(/<p>/g, "<p style='color:#007AFF'>");
            }, 300);
        }
    }

    function nav(d) {
        if(cur+d >= 0 && cur+d < pages.length) { cur+=d; render(); }
    }

    function closeBook() {
        document.getElementById('read-view').style.display = 'none';
        document.getElementById('lib-view').style.display = 'block';
    }

    function toggleTrans() {
        trans = !trans;
        const btn = document.getElementById('btn-trans');
        const pTrans = document.getElementById('p-trans');
        
        if(trans) {
            btn.innerText = "Перевод: ON";
            btn.style.background = "#007AFF";
            btn.style.color = "white";
            pTrans.classList.add('visible');
        } else {
            btn.innerText = "Перевод: OFF";
            btn.style.background = "white";
            btn.style.color = "black";
            pTrans.classList.remove('visible');
        }
        render();
    }
    
    function clearDB() {
        indexedDB.deleteDatabase("ReaderV7");
        location.reload();
    }
</script>
</body>
</html>
